from openai import OpenAI
from dotenv import load_dotenv
import os
import asyncio
from concurrent.futures import ThreadPoolExecutor
from pydantic import BaseModel, Field
from typing import Literal, List
import tiktoken
from sympy.physics.units import temperature

# Загружаем переменные из .env
load_dotenv()
openai_key = os.getenv("OPENAI_API_KEY")

executor = ThreadPoolExecutor()

client = OpenAI(
    base_url="https://openrouter.ai/api/v1",
    api_key=openai_key,
)

class ChatMessage(BaseModel):
    role: Literal["system", "user", "assistant"]
    content: str

def sync_openai_chat(prompt: str, sys_type_pompt:bool) -> str:
    SYSTEM_PROMPT_TEXT = """
    Ты пишешь профессиональные резюме. 
    Текст резюме должен быть разделен на четкие блоки. 
    ОБЯЗАТЕЛЬНО между каждым блоком ставь '---' на отдельной строке. 
    Формат ответа должен быть строго такой:

    Опыт работы
    содержимое блока
    ---
    Личные качества
    содержимое блока
    ---
    Образование
    содержимое блока
    ---
    Навыки
    содержимое блока
    ---
    Контактная информация
    содержимое блока

    Требования к блокам:
    • Если нет информации от пользователя, то заполняешь пустые блоки на своё усмотрение, главное чтобы по теме!
    • Форма опыта работы такой: 'Название компании - год начала - год увольнения/по настоящее время и дальше перечисления через '•''
    • Еще перед перечислением мест работы посчитай 'Общий стаж' пользователя и напиши его
    • В 'Контактная информация' используй шаблон: 'Телефон: +7\nТелеграмм: Ваш tg'
    • 'Личные качества' и 'Навыки' - стандартный набор для запрашиваемой должности
    • В 'Личные качества' опиши личные качества в формате рассказа от первого лица, без перечислений Я,Я,Я,Я. Сосредоточьтесь на профессиональных и личностных чертах, которые подчеркивают умения, характер и подход к работе.
    • В 'Образование' используй данные пользователя или подходящий институт по профессии
    • ОБЯЗАТЕЛЬНО используй разделители '---'
    """

    SYSTEM_PROMPT_FILE = """
    Ты перерабатываешь и грамотно оформляешь резюме на основе предоставленных пользователем данных.
    Предоставленный пользователем текста ты должен разделить на блоки:
    Опыт работы, Личные качества, Образование, Навыки, Контактная информация. 
    Текст резюме должен быть разделён на чёткие блоки. 
    ОБЯЗАТЕЛЬНО между каждым блоком ставь '---' на отдельной строке. 
    Если какой-то информации нет, можешь заполнить в произвольной форме, главное чтобы было по теме!
    !!!IMPORTENT!!!
    ОТВЕТ ОБЯЗАТЕЛЬНО ДОЛЖЕН СОДЕРАЖТЬ ВСЕ БЛОКИ В ПРАВИЛЬНОМ ФОРМАТЕ!!! 
    ЕСЛИ В ТЕКСТЕ НЕТ ИНФОРМАЦИИ, ТО ЗАПОЛНИ НА СВОЕ УСМОТРЕНИЕ!!!
    НИЧЕГО КРОМЕ БЛОКОВ РЕЗЮМЕ ПИСАТЬ НЕ НУЖНО, НИКАКИХ КОММЕНТАРИЕВ И Т.Д!!!
    !!!IMPORTENT!!!
    Формат ответа должен быть строго таким:

    Опыт работы
    содержимое блока о местах работы пользователя.
    Вот тебе пример структуры: 
    Вайлдберриз, ООО - Сентябрь 2023 - настоящее время - Product Owner (Тарификация и фин продукты логистики)
    • Построение аналитики и лидирование команды из шести человек....
    • Общение с бизнес-стороной и выполнение ролей Product Owner и продуктового/системного аналитика....
    ---
    Личные качества
    содержимое блока
    ---
    Образование
    Место где учился пользователь, если нет информации, то произвольно заполнить
    ---
    Навыки
    Перечислить навыки пользователя из предоставленного пользователем текста 
    ---
    Контактная информация
    содержимое блока

    Требования к блокам:
    • Переформулируй предоставленные данные профессионально, сохраняя их суть. Если данные неполные, дополни их подходящей информацией, соответствующей должности (например, Product Owner или продуктовый аналитик).
    • Форма опыта работы: 'Название компании - год начала - год увольнения/по настоящее время', затем перечисления обязанностей или достижений через '•'. Перед перечислением мест работы рассчитай и укажи 'Общий стаж' на основе дат. Объедини проекты в рамках одной компании в описание этой компании, если они относятся к той же роли.
    • В 'Контактная информация' используй шаблон: 'Телефон: +7 (XXX) XXX-XX-XX\nТелеграм: @username'. Если данные не предоставлены, используй placeholder: 'Телефон: +7 (999) 123-45-67\nТелеграм: @username'.
    • В 'Личные качества' переформулируй качества в формате рассказа от первого лица, избегая повторяющихся 'Я, Я, Я'. Опиши профессиональные и личностные черты, подчёркивающие умения, характер и подход к работе, соответствующие должности Product Owner или аналитика.
    • В 'Образование' переформулируй данные пользователя. Если указан конкретный вуз (например, Московский технический университет связи и информатики), используй его, дополнив специальностью, подходящей для должности (например, 'Информационные технологии' или 'Управление продуктами'). Если данные отсутствуют, укажи подходящий вуз и специальность.
    • В 'Навыки' переформулируй или дополни навыки профессиональной терминологией, подходящей для должности (например, управление продуктом, аналитика данных, работа с BI-инструментами, SQL, Python).
    • Сохраняй профессиональный, лаконичный и структурированный стиль. Убедись, что текст не содержит лишних деталей и сосредоточен на ключевых достижениях.
    • ОБЯЗАТЕЛЬНО используй разделители '---'.
    """
    SYSTEM_PROMPT = ''

    if sys_type_pompt:
        SYSTEM_PROMPT = SYSTEM_PROMPT_TEXT
    else:
        SYSTEM_PROMPT = SYSTEM_PROMPT_FILE
    messages = [
        ChatMessage(role="system", content=SYSTEM_PROMPT),
        ChatMessage(role="user", content=prompt),
    ]


    completion = client.chat.completions.create(
        model="mistralai/mistral-small-3.2-24b-instruct:free",
        messages=[m.model_dump() for m in messages],
        max_tokens=5000,
        temperature=0.7
    )


    return completion.choices[0].message.content


async def call_openai(prompt: str, type_prompt:bool) -> str:
    loop = asyncio.get_running_loop()
    return await loop.run_in_executor(executor, sync_openai_chat, prompt, type_prompt)